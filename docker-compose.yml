version: '3.7'

services:
  nginx:
    container_name: nginx
    image: nginx:1.17.5-alpine
    tty: true
    restart: always
    volumes:
      - type: bind
        source: $PRODUCT_DIR/packages/nginx/nginx.conf
        target: /etc/nginx/nginx.conf
      - type: bind
        source: $PRODUCT_DIR/packages/nginx/conf.d
        target: /etc/nginx/conf.d
      - type: bind
        source: $PRODUCT_DIR/packages/nginx/certs
        target: /etc/nginx/certs
    domainname: product.anoriqq.local
    hostname: product.anoriqq.local
    expose:
      - '80'
      - '443'
    ports:
      - '80:80'
      - '443:443'
    networks:
      product_network:
        aliases:
          - anoriqq.local
          - product.anoriqq.local

  mongodb:
    container_name: mongodb
    image: mongo:4.2.1-bionic
    tty: true
    restart: always
    volumes:
      - $PRODUCT_DIR/packages/mongodb/db:/data/db
      - $PRODUCT_DIR/packages/mongodb/mongod.conf:/etc/mongod.conf
      - $PRODUCT_DIR/packages/mongodb/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    domainname: mongodb
    hostname: mongodb
    expose:
      - '27017'
    ports:
      - '27017:27017' # For debug
    networks:
      product_network:
    env_file:
      - $PRODUCT_DIR/packages/mongodb/.env

  portfolio:
    container_name: portfolio
    build:
      context: $PRODUCT_DIR/packages/portfolio
    init: true
    tty: true
    restart: always
    domainname: portfolio
    hostname: portfolio
    expose:
      - '8000'
    networks:
      product_network:
        aliases:
          - anoriqq.local
          - product.anoriqq.local

  delay-tweet:
    container_name: delay-tweet
    build:
      context: $PRODUCT_DIR/packages/delay-tweet
      dockerfile: dev.Dockerfile
    init: true
    tty: true
    restart: always
    volumes:
      - type: bind
        source: $PRODUCT_DIR/packages/delay-tweet
        target: /usr/src/app
    domainname: delay-tweet
    hostname: delay-tweet
    expose:
      - '8000'
    networks:
      product_network:
        aliases:
          - delay-tweet.anoriqq.local
    env_file:
      - $PRODUCT_DIR/packages/delay-tweet/.env
    command: yarn debug

networks:
  product_network:
